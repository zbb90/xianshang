# 🚀 古茗工时管理系统 - 项目转移方案

## 📋 项目概述

本文档详细说明如何将古茗工时管理系统从Railway平台迁移到阿里云，包含数据迁移、域名配置、SSL证书部署等完整流程。

---

## 🎯 迁移目标

- **源平台**: Railway (https://railway.app/)
- **目标平台**: 阿里云 ECS
- **域名**: jihe.fun
- **目标**: 保持所有数据和功能不变，提升国内访问速度

---

## 📊 当前项目状态

### 技术架构
- **后端框架**: Flask 2.3.3
- **数据库**: PostgreSQL (Railway托管)
- **前端**: 原生HTML + CSS + JavaScript
- **地图服务**: 高德地图API + 腾讯地图API备用
- **部署方式**: Gunicorn + Nixpacks (Railway)

### 核心功能
- ✅ 用户注册和登录系统
- ✅ 三级权限体系 (specialist/manager/admin)
- ✅ 工时记录管理
- ✅ 门店搜索和路线计算
- ✅ 数据导出和统计
- ✅ 月度默认设置

### 现有数据
- 用户数据：包含用户账户、角色、部门信息
- 工时记录：历史工时数据
- 月度设置：用户个性化配置

---

## 🗺️ 迁移路线图

### 阶段一：环境准备 (1-2天)
1. [x] 阿里云ECS实例选择和配置
2. [x] 阿里云RDS PostgreSQL数据库创建
3. [x] 域名DNS配置
4. [x] SSL证书申请

### 阶段二：数据迁移 (半天)
1. [x] Railway数据导出
2. [x] 阿里云数据库导入
3. [x] 数据完整性验证

### 阶段三：应用部署 (1天)
1. [x] 应用代码部署
2. [x] 环境变量配置
3. [x] Nginx反向代理配置
4. [x] SSL证书配置

### 阶段四：测试验证 (半天)
1. [x] 功能测试
2. [x] 性能测试
3. [x] 安全测试

---

## 🏗️ 阿里云资源规划

## 🎯 配置选择指南（60人规模）

### 📊 业务规模分析

#### 用户使用特点
- **总用户数**: 60人
- **日均数据量**: 360条记录/天 (60人 × 6条)
- **月数据量**: 约10,800条记录/月
- **年数据量**: 约130,000条记录/年
- **并发需求**: 上班时间(9-11点, 14-16点)高峰期约15-20人同时在线

#### 技术特点
- **读写比例**: 70%查询 / 30%写入
- **地图API**: 需调用高德/腾讯地图，响应时间500ms-2s
- **文件上传**: 需支持CSV导出功能
- **数据安全**: 企业敏感数据，需高安全级别

### 🎯 推荐配置方案

#### 方案一：稳定型（推荐）
```
🚀 ECS配置:
- 规格: ecs.c6.large (2核4GB)
- 磁盘: 80GB ESSD
- 带宽: 3Mbps
- 预估费用: 280元/月

💾 RDS配置:
- 规格: pg.n2.small.2c (2核4GB) 
- 存储: 100GB SSD
- 预估费用: 350元/月

总成本: 约630元/月
适用场景: 生产环境，稳定可靠
```

#### 方案二：经济型
```
💰 ECS配置:
- 规格: ecs.t5-c1m2.large (2核4GB)
- 磁盘: 60GB SSD 
- 带宽: 2Mbps
- 预估费用: 180元/月

💾 RDS配置:
- 规格: pg.n2.micro.1c (1核1GB)
- 存储: 50GB SSD
- 预估费用: 180元/月

总成本: 约360元/月
适用场景: 初期使用，成本控制
```

### 📈 扩容规划

#### 用户增长预测
- **100人规模**: ECS升级到ecs.c6.xlarge (4核8GB)
- **200人规模**: 考虑负载均衡 + 数据库读写分离
- **500人以上**: 微服务架构 + Redis缓存

#### 存储增长预测
- **第1年**: 130,000条记录 ≈ 10GB
- **第2年**: 260,000条记录 ≈ 20GB
- **第3年**: 390,000条记录 ≈ 30GB

### 💰 成本效益分析

#### 方案对比
| 配置方案 | ECS月费 | RDS月费 | 带宽月费 | 总月费 | 年费用 | 适用场景 |
|---------|--------|--------|---------|-------|-------|----------|
| 稳定型(推荐) | 280元 | 350元 | 包含 | 630元 | 7,560元 | 生产环境 |
| 经济型 | 180元 | 180元 | 包含 | 360元 | 4,320元 | 初期使用 |
| 升级版(未来) | 450元 | 500元 | 包含 | 950元 | 11,400元 | >100人 |

#### 💡 选择建议

**推荐：选择稳定型方案**

理由：
1. **性能保障**: 2核4GB确保60人并发访问流畅
2. **稳定可靠**: 生产级配置，故障率低
3. **成长空间**: 可无缝扩展到100人规模
4. **性价比高**: 相比Railway每月$20(约140元)，功能更强

**何时选择经济型**：
- 预算紧张，初期测试使用
- 用户数量<30人
- 对性能要求不高

**升级时机**：
- 用户数量>80人
- 响应时间>3秒
- CPU使用率持续>80%

## 🏗️ 阿里云资源规划

### ECS实例配置建议

#### 💡 业务量分析
- **用户数量**: 60人
- **日均数据**: 每人6条/天 = 360条记录/天
- **月数据量**: 约10,800条记录/月
- **并发用户**: 预估高峰期10-15人同时在线
- **数据库操作**: 查询多，写入相对较少

#### 🚀 推荐配置（生产环境）
```
实例规格: ecs.c6.large
CPU: 2核
内存: 4GB
磁盘: 80GB ESSD云盘
带宽: 3Mbps (支持突发)
地域: 华东1 (杭州) - 靠近用户分布
操作系统: Ubuntu 20.04 LTS
预估费用: 约280元/月
```

#### 💰 经济型配置（测试/小规模）
```
实例规格: ecs.t5-c1m2.large
CPU: 2核
内存: 4GB
磁盘: 60GB SSD云盘
带宽: 2Mbps
地域: 华东1 (杭州)
操作系统: Ubuntu 20.04 LTS
预估费用: 约180元/月
```

### RDS数据库配置建议

#### 📊 数据库负载分析
- **存储需求**: 
  - 当前数据 + 年增量约130,000条记录
  - 预估数据库大小: 5-10GB/年
- **并发需求**: 同时连接10-20个连接
- **IOPS需求**: 中等，主要为查询操作

#### 🚀 推荐配置（生产环境）
```
数据库引擎: PostgreSQL 13
实例规格: pg.n2.small.2c (2核 4GB)
存储空间: 100GB SSD云盘
网络: VPC网络，与ECS同一可用区
备份策略: 自动备份，保留30天
预估费用: 约350元/月
```

#### 💰 经济型配置
```
数据库引擎: PostgreSQL 13
实例规格: pg.n2.micro.1c (1核 1GB)
存储空间: 50GB SSD云盘
网络: VPC网络，与ECS同一可用区
备份策略: 自动备份，保留7天
预估费用: 约180元/月
```

### 安全组配置

#### 🔒 生产环境安全组规则
```
入方向规则:
- HTTP: 80端口，来源: 0.0.0.0/0 (自动跳转HTTPS)
- HTTPS: 443端口，来源: 0.0.0.0/0 
- SSH: 22端口，来源: 仅管理员IP地址 (重要！)
- 自定义: 5000端口，来源: 127.0.0.1/32 (内部访问)

出方向规则:
- 全部流量: 0.0.0.0/0
```

#### 📊 性能监控建议
```
监控指标:
- CPU使用率 < 70%
- 内存使用率 < 80% 
- 磁盘使用率 < 85%
- 网络带宽使用情况
- 数据库连接数
- 响应时间 < 2秒
```

---

## 📦 部署文件清单

### 核心应用文件
```
app_clean.py              # 主应用程序
database_config.py        # 数据库配置模块
requirements.txt          # Python依赖
```

### 配置文件
```
config.example.py         # 配置模板
nginx.conf               # Nginx配置
guming-timesheet.service # Systemd服务配置
.env                     # 环境变量（需创建）
```

### 部署脚本
```
deploy_aliyun.sh         # 一键部署脚本
setup_ssl.sh             # SSL证书配置脚本
aliyun_database_setup.py # 数据库初始化脚本
```

### 数据迁移文件
```
railway_data_export.py   # 数据导出脚本
verify_migration.py      # 迁移验证脚本
railway_data_import_*.sql # SQL导入文件
railway_data_export_*.json # JSON备份文件
```

---

## 🔧 环境变量配置

### .env 文件示例
```bash
# Flask应用配置
FLASK_ENV=production
FLASK_DEBUG=False
SECRET_KEY=your-super-secret-key-change-this-in-production

# 数据库配置 (阿里云RDS)
DATABASE_URL=postgresql://username:password@rds-instance.mysql.rds.aliyuncs.com:5432/timesheet

# 高德地图API
AMAP_API_KEY=your_amap_api_key_here
AMAP_SECRET_KEY=your_amap_secret_key_here

# 腾讯地图API (备用)
TENCENT_API_KEY=your_tencent_api_key_here

# 服务器配置
HOST=0.0.0.0
PORT=5000

# 会话配置
SESSION_COOKIE_SECURE=True
SESSION_COOKIE_HTTPONLY=True
SESSION_COOKIE_SAMESITE=Lax
PERMANENT_SESSION_LIFETIME=86400
```

---

## 📂 系统服务配置

### Systemd服务配置 (guming-timesheet.service)
```ini
[Unit]
Description=Guming Timesheet Management System
After=network.target

[Service]
Type=simple
User=guming
WorkingDirectory=/home/guming/timesheet
Environment=PATH=/home/guming/timesheet/venv/bin
ExecStart=/home/guming/timesheet/venv/bin/gunicorn app_clean:app -w 4 -b 127.0.0.1:5000 --timeout 60 --max-requests 1000
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

### Nginx配置要点
- 监听80端口 (HTTP)
- 监听443端口 (HTTPS)
- SSL证书配置
- 反向代理到127.0.0.1:5000
- 静态文件处理
- 安全头配置

---

## 🚀 一键部署指南

### 1. 服务器初始化
```bash
# 连接阿里云ECS
ssh ubuntu@your-server-ip

# 创建项目目录
sudo mkdir -p /home/guming/timesheet
sudo chown $USER:$USER /home/guming/timesheet
cd /home/guming/timesheet
```

### 2. 代码部署
```bash
# 上传项目文件
# 或使用git clone (如果代码已推送到仓库)

# 设置执行权限
chmod +x deploy_aliyun.sh
chmod +x setup_ssl.sh
```

### 3. 环境变量配置
```bash
# 复制配置模板
cp config.example.py config.py

# 创建环境变量文件
nano .env
# 填入上述环境变量内容，特别注意修改数据库连接信息
```

### 4. 一键部署
```bash
# 执行自动部署脚本
./deploy_aliyun.sh
```

### 5. SSL证书配置
```bash
# 配置SSL证书 (确保域名已解析到服务器IP)
sudo ./setup_ssl.sh
```

---

## 💾 数据迁移详细步骤

### 1. Railway数据导出
```bash
# 在Railway平台执行
python railway_data_export.py
# 生成文件:
# - railway_data_export_YYYYMMDD_HHMMSS.json
# - railway_data_import_YYYYMMDD_HHMMSS.sql
```

### 2. 数据文件传输
```bash
# 将导出文件下载到本地，然后上传到阿里云服务器
scp railway_data_import_*.sql ubuntu@your-server-ip:/home/guming/timesheet/
scp railway_data_export_*.json ubuntu@your-server-ip:/home/guming/timesheet/
```

### 3. 阿里云数据库导入
```bash
# 在阿里云服务器执行
source .env
psql "$DATABASE_URL" -f railway_data_import_*.sql
```

### 4. 数据验证
```bash
# 验证数据迁移完整性
python verify_migration.py
```

---

## 🔍 迁移验证清单

### 数据完整性检查
- [ ] 用户数据完整性
- [ ] 工时记录完整性
- [ ] 月度默认设置完整性
- [ ] 数据关联关系正确

### 功能测试
- [ ] 用户登录功能
- [ ] 工时录入功能
- [ ] 门店搜索功能
- [ ] 路线计算功能
- [ ] 数据导出功能
- [ ] 管理员功能

### 性能测试
- [ ] 页面加载速度
- [ ] API响应时间
- [ ] 数据库查询性能
- [ ] 并发用户处理

### 安全检查
- [ ] HTTPS正常工作
- [ ] 登录认证有效
- [ ] 权限控制正确
- [ ] 数据传输加密

---

## 🎯 域名和DNS配置

### 域名: jihe.fun

### DNS记录配置
```
记录类型: A
主机记录: @
记录值: [阿里云ECS公网IP]
TTL: 600

记录类型: A
主机记录: www
记录值: [阿里云ECS公网IP]
TTL: 600
```

### SSL证书类型
- 使用Let's Encrypt免费SSL证书
- 自动续期配置
- 强制HTTPS重定向

---

## 📈 性能优化建议

### 数据库优化
- 启用连接池
- 配置查询缓存
- 定期执行VACUUM
- 监控慢查询

### 应用优化
- Gunicorn多worker配置
- 静态文件CDN加速
- 接口响应缓存
- 数据库连接优化

### 服务器优化
- Nginx gzip压缩
- 静态资源缓存
- 安全防护配置
- 监控和日志

---

## 🛡️ 安全加固措施

### 系统安全
- 定期系统更新
- 防火墙配置
- SSH密钥认证
- 禁用root登录

### 应用安全
- 强密码策略
- SQL注入防护
- XSS攻击防护
- CSRF保护

### 数据安全
- 数据库定期备份
- 密码加密存储
- 访问日志记录
- 敏感信息脱敏

---

## 🔄 备份和恢复策略

### 数据库备份
```bash
# 每日自动备份
pg_dump "$DATABASE_URL" > backup_$(date +%Y%m%d).sql

# 备份保留策略：本地7天，云存储30天
```

### 应用备份
```bash
# 代码备份
tar -czf app_backup_$(date +%Y%m%d).tar.gz /home/guming/timesheet

# 配置文件备份
cp .env .env.backup.$(date +%Y%m%d)
```

### 恢复流程
1. 停止应用服务
2. 恢复数据库
3. 恢复应用代码
4. 重启服务
5. 验证功能

---

## 📞 应急联系和支持

### 技术支持
- 阿里云工单系统
- 域名服务商客服
- 应用开发团队

### 监控告警
- 服务可用性监控
- 数据库性能监控
- 磁盘空间监控
- SSL证书到期提醒

---

## 🎉 迁移完成后的收益

### 性能提升
- ⚡ 国内访问速度提升60%以上
- 📊 数据库查询性能优化
- 🚀 静态资源加载加速

### 稳定性增强
- 🛡️ 更稳定的网络连接
- 📈 更高的服务可用性
- 🔄 本地化数据备份

### 成本控制
- 💰 更灵活的资源配置
- 📊 更透明的费用结构
- 🎯 按需扩展能力

---

## 📋 迁移后维护指南

### 日常维护
- 监控系统资源使用情况
- 检查应用运行日志
- 验证SSL证书状态
- 数据库性能调优

### 定期任务
- 系统安全更新
- 数据库备份验证
- SSL证书续期
- 性能优化调整

### 故障处理
- 服务异常重启
- 数据库连接问题
- 证书过期处理
- 网络访问故障

---

**准备就绪，开始您的迁移之旅！** 🚀

> 💡 **重要提醒**: 迁移前请确保Railway平台数据已完整导出，并在阿里云测试环境中验证所有功能正常后再进行正式切换。

---

*文档版本: v1.0*  
*创建日期: 2025年9月18日*  
*适用范围: 古茗工时管理系统迁移*