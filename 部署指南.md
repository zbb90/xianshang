# 智能工时表管理系统 - 公网部署指南

## 🌟 功能特性

- ✅ **用户注册登录** - 完整的用户认证系统
- ✅ **工时管理** - 支持门店编码输入，自动显示门店名称
- ✅ **路线规划** - 集成高德地图API，默认选择时间最短路线
- ✅ **门店管理** - 支持门店信息导入导出
- ✅ **数据导出** - Excel格式导出工时表数据
- ✅ **性能优化** - 分页加载，搜索功能
- ✅ **安全认证** - 密码加密，会话管理

## 🚀 部署选项

### 选项1：传统服务器部署

#### 1. 环境准备
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Python 3.9+
sudo apt install python3 python3-pip python3-venv -y

# 安装Nginx（可选）
sudo apt install nginx -y
```

#### 2. 下载项目
```bash
# 克隆或上传项目文件到服务器
cd /opt
sudo git clone <your-repo-url> timesheet-system
cd timesheet-system
sudo chown -R $USER:$USER .
```

#### 3. 配置环境
```bash
# 创建环境配置文件
cp env.example .env

# 编辑配置文件
nano .env
```

**重要配置项：**
```env
# 必须修改的配置
SECRET_KEY=your_super_secret_key_here_change_this
AMAP_API_KEY=your_amap_api_key
AMAP_SECRET_KEY=your_amap_secret_key

# 生产环境配置
FLASK_ENV=production
FLASK_DEBUG=False
SESSION_COOKIE_SECURE=True  # 使用HTTPS时设为True
```

#### 4. 安装依赖
```bash
# 运行部署脚本
chmod +x deploy.sh
./deploy.sh
```

#### 5. 启动服务
```bash
# 生产环境启动
gunicorn -c gunicorn.conf.py wsgi:app

# 或使用nohup后台运行
nohup gunicorn -c gunicorn.conf.py wsgi:app > app.log 2>&1 &
```

#### 6. 配置Nginx反向代理（推荐）
```bash
# 复制Nginx配置
sudo cp nginx.conf /etc/nginx/sites-available/timesheet
sudo ln -s /etc/nginx/sites-available/timesheet /etc/nginx/sites-enabled/

# 删除默认配置
sudo rm /etc/nginx/sites-enabled/default

# 重启Nginx
sudo systemctl restart nginx
```

### 选项2：Docker容器部署

#### 1. 安装Docker和Docker Compose
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo apt install docker-compose-plugin -y
```

#### 2. 配置环境变量
```bash
# 创建.env文件
cp env.example .env
nano .env
```

#### 3. 启动容器
```bash
# 构建并启动
docker compose up -d

# 查看日志
docker compose logs -f

# 包含Nginx反向代理
docker compose --profile nginx up -d
```

### 选项3：云平台部署

#### 腾讯云/阿里云/华为云
1. 创建云服务器实例（建议2核4G以上）
2. 配置安全组开放8080端口（或80/443端口）
3. 按照传统服务器部署方式进行部署

#### Vercel/Railway/Render
这些平台支持Python应用，可以直接部署：
1. 连接GitHub仓库
2. 设置环境变量
3. 使用wsgi.py作为入口文件

## 🔐 安全配置

### 1. 防火墙设置
```bash
# 使用ufw配置防火墙
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 2. SSL证书（推荐）
```bash
# 使用Let's Encrypt获取免费SSL证书
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d yourdomain.com
```

### 3. 定期备份
```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
cp enhanced_timesheet.db backups/db_backup_$DATE.db
find backups/ -name "*.db" -mtime +30 -delete
EOF

chmod +x backup.sh

# 添加到cron定时任务
crontab -e
# 添加行：0 2 * * * /opt/timesheet-system/backup.sh
```

## 📊 监控和维护

### 1. 应用监控
```bash
# 查看应用状态
ps aux | grep gunicorn

# 查看端口占用
netstat -tlnp | grep 8080

# 查看日志
tail -f app.log
```

### 2. 系统监控
```bash
# 安装监控工具
sudo apt install htop iotop -y

# 查看系统资源
htop
```

### 3. 数据库维护
```bash
# 数据库备份
sqlite3 enhanced_timesheet.db ".backup backup.db"

# 数据库优化
sqlite3 enhanced_timesheet.db "VACUUM;"
```

## 🌍 域名和DNS配置

### 1. 域名解析
将域名的A记录指向服务器IP地址：
```
类型: A
主机记录: @（或www）
记录值: 您的服务器IP
TTL: 600
```

### 2. 子域名配置（可选）
```
类型: A
主机记录: timesheet
记录值: 您的服务器IP
TTL: 600
```

## 📋 默认账户

系统启动后，建议立即注册管理员账户：
1. 访问 `http://your-domain.com/register`
2. 注册第一个用户（建议设置为"管理员"职位）
3. 后续用户可通过注册页面自助注册

## ⚡ 性能优化

### 1. 应用层优化
- 已实现分页加载门店数据
- 已添加搜索功能减少数据传输
- 使用Gunicorn多进程部署

### 2. 服务器优化
```bash
# 调整系统限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 65536" >> /etc/sysctl.conf
sysctl -p
```

### 3. 数据库优化
```sql
-- 定期清理过期会话数据（如果需要）
-- 可以添加定时任务清理
```

## 🔧 故障排查

### 常见问题

1. **服务无法启动**
   - 检查端口是否被占用：`netstat -tlnp | grep 8080`
   - 检查配置文件语法：`python3 -c "import enhanced_final_app"`

2. **登录失败**
   - 检查数据库文件权限
   - 验证bcrypt库是否正确安装

3. **高德API调用失败**
   - 验证API密钥是否正确
   - 检查网络连接
   - 查看API调用日志

4. **门店导入失败**
   - 检查CSV文件格式
   - 验证经纬度数据格式

### 日志分析
```bash
# 查看错误日志
grep -i error app.log

# 查看API调用日志
grep "API" app.log

# 实时监控日志
tail -f app.log | grep -E "(ERROR|WARNING)"
```

## 🆕 版本更新

```bash
# 备份当前版本
cp enhanced_final_app.py enhanced_final_app.py.backup
cp enhanced_timesheet.db enhanced_timesheet.db.backup

# 更新代码
git pull origin main  # 或上传新版本文件

# 重启服务
pkill gunicorn
gunicorn -c gunicorn.conf.py wsgi:app
```

## 📞 技术支持

- 系统自带用户注册功能，无需额外配置
- 路线策略默认为"时间最短"，提供最优用户体验
- 支持超过13,000个门店数据的高效管理
- 完整的权限控制和安全认证机制

---

**部署完成后访问：**
- HTTP: `http://your-domain.com:8080`
- HTTPS（配置SSL后）: `https://your-domain.com`

首次访问会自动跳转到登录页面，点击"立即注册"创建您的账户即可开始使用！
